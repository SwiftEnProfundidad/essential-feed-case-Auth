# BDD - Security & User Management Features

## Estado de ImplementaciÃ³n
- âœ… Completado
- ğŸ”œ Siguiente a implementar
- ğŸ”„ Pendiente

---

## Resumen Actualizado de Estado de ImplementaciÃ³n
| Caso de Uso                                   | Estado                  |
|-----------------------------------------------|-------------------------|
| 1. Almacenamiento Seguro                     | ğŸ”œ Siguiente a implementar |
| 2. Registro de Usuario                       | ğŸ”„ Pendiente             |
| 3. AutenticaciÃ³n de Usuario                  | ğŸ”„ Pendiente             |
| 4. GestiÃ³n de Token Expirado                 | ğŸ”„ Pendiente             |
| 5. RecuperaciÃ³n de ContraseÃ±a                | ğŸ”„ Pendiente             |
| 6. GestiÃ³n de Sesiones                       | ğŸ”„ Pendiente             |
| 7. Cambio de ContraseÃ±a                      | ğŸ”„ Pendiente             |
| 8. VerificaciÃ³n de Cuenta                    | ğŸ”„ Pendiente             |
| 9. AutenticaciÃ³n con Proveedores Externos    | ğŸ”„ Pendiente             |
| 10. MÃ©tricas de Seguridad                    | ğŸ”„ Pendiente             |

---

## 1. Almacenamiento Seguro (SecureStorage)

### Caso de Uso: Almacenamiento Seguro
**Datos:**
- âœ… InformaciÃ³n sensible a proteger
- âœ… Nivel de protecciÃ³n requerido

**Curso Principal (happy path):**
- âœ… Sistema determina el nivel de protecciÃ³n necesario.
- âœ… Sistema encripta la informaciÃ³n si es necesario. _(cubierto por tests)_
- ğŸ”„ Sistema almacena en el Keychain con configuraciÃ³n adecuada. _(pendiente de integraciÃ³n real con Keychain)_
- ğŸ”„ Sistema verifica el almacenamiento correcto. _(falta integraciÃ³n real)_

**Curso de error - error de Keychain (sad path):**
- ğŸ”„ Sistema intenta estrategia alternativa de almacenamiento.
- ğŸ”„ Sistema notifica error si persiste.
- ğŸ”„ Sistema registra error para diagnÃ³stico.

**Curso de error - datos corruptos (sad path):**
- ğŸ”„ Sistema detecta inconsistencia en datos.
- ğŸ”„ Sistema limpia los datos corruptos.
- ğŸ”„ Sistema solicita nueva autenticaciÃ³n si es necesario.

**ImplementaciÃ³n:**
- âœ… Protocolo SecureStorage que define operaciones de guardado, recuperaciÃ³n y eliminaciÃ³n
- âœ… ImplementaciÃ³n del mÃ©todo protectionLevel para determinar nivel de seguridad
- ğŸ”„ ImplementaciÃ³n KeychainSecureStorage usando el Keychain de iOS
- âœ… Pruebas unitarias completas que validan todos los escenarios del dominio SecureStorage

---

## 2. Registro de Usuario
**Historia:** Usuario nuevo solicita registrarse en la aplicaciÃ³n

### Narrativa
Como nuevo usuario
Quiero poder registrarme en la aplicaciÃ³n
Para crear una cuenta y acceder a las funcionalidades

### Escenarios (Criterios de aceptaciÃ³n)
- ğŸ”„ Registro exitoso
- ğŸ”„ Error de datos invÃ¡lidos
- ğŸ”„ Error de correo ya registrado
- ğŸ”„ Error de conexiÃ³n

### ImplementaciÃ³n
- ğŸ”„ Comando "Registrar Usuario" y validaciones
- ğŸ”„ Almacenamiento seguro de credenciales

---

## 3. AutenticaciÃ³n de Usuario
**Historia:** Usuario solicita autenticarse en la aplicaciÃ³n

### Escenarios (Criterios de aceptaciÃ³n)
- ğŸ”„ Inicio de sesiÃ³n exitoso
- ğŸ”„ Error de credenciales incorrectas
- ğŸ”„ Error de conexiÃ³n
- ğŸ”„ Cierre de sesiÃ³n exitoso
- ğŸ”„ RestauraciÃ³n de sesiÃ³n al inicio de aplicaciÃ³n
- ğŸ”„ DetecciÃ³n de token expirado durante uso
- ğŸ”„ MÃºltiples intentos fallidos de autenticaciÃ³n

---

## 4. GestiÃ³n de Token Expirado
Historia: Sistema maneja tokens expirados y actualizaciÃ³n automÃ¡tica

**Narrativa**
Como sistema de autenticaciÃ³n
Quiero manejar correctamente los tokens expirados
Para ofrecer una experiencia fluida al usuario manteniendo la seguridad

**Escenarios (Criterios de aceptaciÃ³n)**
- Escenario 1: RenovaciÃ³n automÃ¡tica del token
  - Dado que el token de acceso del usuario ha expirado
  - Cuando la aplicaciÃ³n intenta realizar una operaciÃ³n autenticada
  - Entonces el sistema debe detectar la expiraciÃ³n
  - Y utilizar el refresh token para obtener un nuevo token de acceso
  - Y continuar la operaciÃ³n sin intervenciÃ³n del usuario
- Escenario 2: Error en renovaciÃ³n de token
  - Dado que el token de acceso ha expirado
  - Cuando el refresh token tambiÃ©n ha expirado o es invÃ¡lido
  - Entonces el sistema debe solicitar al usuario iniciar sesiÃ³n nuevamente
  - Y preservar el estado de la operaciÃ³n interrumpida
  - Y restaurar la operaciÃ³n tras la nueva autenticaciÃ³n
- Escenario 3: RevocaciÃ³n preventiva de tokens
  - Dado que se detecta una actividad sospechosa
  - Cuando el sistema lo identifica como un riesgo de seguridad
  - Entonces el sistema debe revocar todos los tokens activos
  - Y solicitar una nueva autenticaciÃ³n
  - Y notificar al usuario sobre la acciÃ³n realizada

**Caso de Uso TÃ©cnico: GestiÃ³n de Token Expirado**
- Datos: Token de acceso expirado, Refresh token
- Curso Principal (happy path):
  - Sistema detecta token de acceso expirado.
  - Sistema ejecuta comando "Renovar Token" con el refresh token.
  - Sistema recibe nuevo token de acceso.
  - Sistema actualiza el token almacenado.
  - Sistema continÃºa la operaciÃ³n original sin interrupciÃ³n para el usuario.
- Curso de error - refresh token expirado (sad path):
  - Sistema notifica necesidad de nueva autenticaciÃ³n.
  - Sistema preserva el estado de la operaciÃ³n en curso.
  - Sistema dirige al usuario al flujo de inicio de sesiÃ³n.
  - Sistema restaura operaciÃ³n despuÃ©s de autenticaciÃ³n exitosa.
- Curso de error - error de servidor (sad path):
  - Sistema intenta reintento con backoff exponencial.
  - Si persiste, notifica al usuario del problema.
  - Sistema ofrece opciÃ³n de reintento manual.

---

## 5. RecuperaciÃ³n de ContraseÃ±a
Historia: Usuario solicita recuperar su contraseÃ±a

**Narrativa**
Como usuario que ha olvidado su contraseÃ±a
Quiero poder restablecerla de manera segura
Para recuperar el acceso a mi cuenta

**Escenarios (Criterios de aceptaciÃ³n)**
- Escenario 1: Solicitud de recuperaciÃ³n exitosa
  - Dado que el usuario introduce un correo electrÃ³nico registrado
  - Cuando solicita restablecer su contraseÃ±a
  - Entonces la aplicaciÃ³n debe enviar un enlace de restablecimiento al correo
  - Y mostrar un mensaje de confirmaciÃ³n
  - Y registrar la solicitud en los logs de seguridad
- Escenario 2: Error de correo no registrado
  - Dado que el usuario introduce un correo electrÃ³nico no registrado
  - Cuando intenta solicitar un restablecimiento de contraseÃ±a
  - Entonces la aplicaciÃ³n debe mostrar un mensaje indicando que se han enviado instrucciones si el correo existe
  - Sin revelar si el correo existe o no por razones de seguridad
  - Y aplicar el mismo tiempo de respuesta que una solicitud exitosa
- Escenario 3: Restablecimiento de contraseÃ±a exitoso
  - Dado que el usuario ha recibido un enlace de restablecimiento vÃ¡lido
  - Cuando introduce una nueva contraseÃ±a que cumple con los requisitos
  - Entonces la aplicaciÃ³n debe actualizar la contraseÃ±a
  - Y redirigir al usuario a la pantalla de inicio de sesiÃ³n con un mensaje de Ã©xito
  - Y notificar al usuario por correo sobre el cambio de contraseÃ±a
- Escenario 4: Error de enlace expirado o invÃ¡lido
  - Dado que el usuario intenta usar un enlace expirado o invÃ¡lido
  - Cuando accede al enlace de restablecimiento
  - Entonces la aplicaciÃ³n debe mostrar un mensaje de error
  - Y permitir solicitar un nuevo enlace
  - Y registrar el intento fallido para detecciÃ³n de ataques

**Caso de Uso TÃ©cnico: RecuperaciÃ³n de ContraseÃ±a**
- Datos: Correo electrÃ³nico
- Curso Principal (happy path):
  - Ejecutar comando "Solicitar RecuperaciÃ³n" con el correo proporcionado.
  - Sistema valida el formato del correo.
  - Sistema envÃ­a solicitud al servidor.
  - Sistema registra la solicitud en logs de seguridad.
  - Sistema notifica envÃ­o exitoso de instrucciones.
- Curso de error - correo invÃ¡lido (sad path):
  - Sistema notifica error de formato de correo.
- Curso de error - sin conectividad (sad path):
  - Sistema almacena la solicitud para reintentar.
  - Sistema notifica error de conectividad.
  - Sistema ofrece opciÃ³n de reintentar mÃ¡s tarde.

---

## 6. GestiÃ³n de Sesiones
Historia: Usuario quiere gestionar sus sesiones activas

**Narrativa**
Como usuario preocupado por la seguridad
Quiero poder ver y gestionar mis sesiones activas
Para detectar y cerrar accesos no autorizados

**Escenarios (Criterios de aceptaciÃ³n)**
- Escenario 1: VisualizaciÃ³n de sesiones activas
  - Dado que el usuario estÃ¡ autenticado
  - Cuando accede a la secciÃ³n "Mis sesiones"
  - Entonces la aplicaciÃ³n debe mostrar una lista de todas las sesiones activas
  - Con informaciÃ³n de dispositivo, ubicaciÃ³n y fecha de Ãºltimo acceso
  - Y destacar la sesiÃ³n actual del usuario
- Escenario 2: Cierre de sesiÃ³n remota
  - Dado que el usuario visualiza sus sesiones activas
  - Cuando selecciona "Cerrar sesiÃ³n" para una sesiÃ³n especÃ­fica
  - Entonces la aplicaciÃ³n debe invalidar esa sesiÃ³n
  - Y mostrar la lista actualizada de sesiones
  - Y enviar una notificaciÃ³n al dispositivo afectado
- Escenario 3: Cierre de todas las sesiones
  - Dado que el usuario visualiza sus sesiones activas
  - Cuando selecciona "Cerrar todas las sesiones"
  - Entonces la aplicaciÃ³n debe invalidar todas las sesiones excepto la actual
  - Y mostrar confirmaciÃ³n de la acciÃ³n
  - Y actualizar la lista de sesiones
- Escenario 4: DetecciÃ³n de acceso sospechoso
  - Dado que se detecta un inicio de sesiÃ³n desde una ubicaciÃ³n inusual
  - Cuando el sistema lo identifica como potencialmente sospechoso
  - Entonces la aplicaciÃ³n debe notificar al usuario
  - Y ofrecer la opciÃ³n de verificar o cerrar esa sesiÃ³n
  - Y sugerir cambiar la contraseÃ±a por seguridad

**Caso de Uso TÃ©cnico: GestiÃ³n de Sesiones**
- Datos: ID de sesiÃ³n (opcional para cierre especÃ­fico)
- Curso Principal (happy path):
  - Ejecutar comando "Listar Sesiones".
  - Sistema obtiene lista de sesiones del servidor.
  - Sistema procesa y formatea la informaciÃ³n.
  - Sistema entrega lista de sesiones activas.
- Curso alternativo - cerrar sesiÃ³n especÃ­fica:
  - Ejecutar comando "Cerrar SesiÃ³n" con ID especÃ­fico.
  - Sistema envÃ­a solicitud de invalidaciÃ³n al servidor.
  - Sistema notifica al dispositivo afectado si es posible.
  - Sistema notifica cierre exitoso.
- Curso alternativo - cerrar todas las sesiones:
  - Ejecutar comando "Cerrar Todas las Sesiones".
  - Sistema envÃ­a solicitud de invalidaciÃ³n masiva al servidor.
  - Sistema excluye la sesiÃ³n actual.
  - Sistema notifica cierre exitoso.
- Curso de error - sin conectividad (sad path):
  - Sistema almacena la solicitud para reintentar.
  - Sistema notifica error de conectividad.
  - Sistema ofrece reintentar cuando la conexiÃ³n se restablezca.

---

## 7. Cambio de ContraseÃ±a
Historia: Usuario autenticado desea cambiar su contraseÃ±a

**Narrativa**
Como usuario autenticado
Quiero poder cambiar mi contraseÃ±a
Para mantener la seguridad de mi cuenta

**Escenarios (Criterios de aceptaciÃ³n)**
- Escenario 1: Cambio de contraseÃ±a exitoso
  - Dado que el usuario estÃ¡ autenticado
  - Cuando introduce correctamente su contraseÃ±a actual y una nueva contraseÃ±a vÃ¡lida
  - Entonces la aplicaciÃ³n debe actualizar la contraseÃ±a
  - Y mostrar un mensaje de confirmaciÃ³n
  - Y actualizar el token de autenticaciÃ³n
  - Y notificar al usuario por correo sobre el cambio realizado
- Escenario 2: Error de contraseÃ±a actual incorrecta
  - Dado que el usuario introduce una contraseÃ±a actual incorrecta
  - Cuando intenta cambiar su contraseÃ±a
  - Entonces la aplicaciÃ³n debe mostrar un mensaje de error
  - Y permitir al usuario intentarlo nuevamente
  - Y registrar el intento fallido para mÃ©tricas de seguridad
- Escenario 3: Error de nueva contraseÃ±a dÃ©bil
  - Dado que el usuario introduce una nueva contraseÃ±a que no cumple con los requisitos de seguridad
  - Cuando intenta cambiar su contraseÃ±a
  - Entonces la aplicaciÃ³n debe mostrar los requisitos no cumplidos
  - Y no permitir el cambio hasta que se cumpla con todos los requisitos
  - Y ofrecer sugerencias para crear una contraseÃ±a segura

**Caso de Uso TÃ©cnico: Cambio de ContraseÃ±a**
- Datos: ContraseÃ±a actual, Nueva contraseÃ±a
- Curso Principal (happy path):
  - Ejecutar comando "Cambiar ContraseÃ±a" con los datos proporcionados.
  - Sistema valida el formato de las contraseÃ±as.
  - Sistema envÃ­a solicitud al servidor.
  - Sistema actualiza las credenciales almacenadas.
  - Sistema actualiza token de sesiÃ³n si es necesario.
  - Sistema notifica cambio exitoso.
- Curso de error - contraseÃ±a actual incorrecta (sad path):
  - Sistema registra el intento fallido.
  - Sistema notifica error de autenticaciÃ³n.
  - Sistema verifica si se debe aplicar restricciÃ³n temporal.
- Curso de error - nueva contraseÃ±a invÃ¡lida (sad path):
  - Sistema notifica requisitos de contraseÃ±a no cumplidos.
  - Sistema ofrece recomendaciones para contraseÃ±a segura.
- Curso de error - sin conectividad (sad path):
  - Sistema almacena la solicitud para reintentar.
  - Sistema notifica error de conectividad.
  - Sistema ofrece opciÃ³n de reintentar mÃ¡s tarde.

---

## 8. VerificaciÃ³n de Cuenta
Historia: Usuario nuevo debe verificar su cuenta

**Narrativa**
Como usuario reciÃ©n registrado
Quiero verificar mi correo electrÃ³nico
Para confirmar mi identidad y activar completamente mi cuenta

**Escenarios (Criterios de aceptaciÃ³n)**
- Escenario 1: VerificaciÃ³n de correo exitosa
  - Dado que el usuario ha recibido un correo con un enlace de verificaciÃ³n
  - Cuando hace clic en el enlace
  - Entonces la aplicaciÃ³n debe marcar la cuenta como verificada
  - Y mostrar un mensaje de Ã©xito
  - Y permitir el inicio de sesiÃ³n completo
  - Y actualizar el estado de verificaciÃ³n en todos los dispositivos
- Escenario 2: ReenvÃ­o de correo de verificaciÃ³n
  - Dado que el usuario no ha recibido o ha perdido el correo de verificaciÃ³n
  - Cuando solicita reenviar el correo de verificaciÃ³n
  - Entonces la aplicaciÃ³n debe enviar un nuevo correo
  - Y mostrar un mensaje de confirmaciÃ³n
  - Y invalidar los enlaces anteriores
- Escenario 3: Error de verificaciÃ³n
  - Dado que el usuario intenta verificar su cuenta
  - Cuando el enlace de verificaciÃ³n ha expirado o es invÃ¡lido
  - Entonces la aplicaciÃ³n debe mostrar un mensaje de error
  - Y permitir solicitar un nuevo enlace de verificaciÃ³n
  - Y registrar el intento fallido
- Escenario 4: Intento de acceso a funciones restringidas sin verificaciÃ³n
  - Dado que el usuario ha iniciado sesiÃ³n pero no ha verificado su cuenta
  - Cuando intenta acceder a funciones que requieren verificaciÃ³n
  - Entonces la aplicaciÃ³n debe mostrar un recordatorio para verificar la cuenta
  - Y ofrecer la opciÃ³n de reenviar el correo de verificaciÃ³n
  - Y permitir continuar con funcionalidades bÃ¡sicas

**Caso de Uso TÃ©cnico: VerificaciÃ³n de Cuenta**
- Datos: Token de verificaciÃ³n
- Curso Principal (happy path):
  - Ejecutar comando "Verificar Cuenta" con el token proporcionado.
  - Sistema valida el token con el servidor.
  - Sistema actualiza estado de cuenta a verificada.
  - Sistema actualiza estado en el SessionManager.
  - Sistema notifica verificaciÃ³n exitosa.
- Curso de error - token invÃ¡lido o expirado (sad path):
  - Sistema registra el intento fallido.
  - Sistema notifica error especÃ­fico del token.
  - Sistema ofrece solicitar nuevo token.
- Curso de error - sin conectividad (sad path):
  - Sistema almacena la verificaciÃ³n para reintentar.
  - Sistema notifica error de conectividad.
  - Sistema reintenta automÃ¡ticamente cuando la conexiÃ³n se restablezca.

---

## 9. AutenticaciÃ³n con Proveedores Externos
Historia: Usuario desea autenticarse mediante proveedores externos

**Narrativa**
Como usuario
Quiero poder iniciar sesiÃ³n con mi cuenta de Google, Facebook o Apple
Para acceder rÃ¡pidamente sin recordar credenciales adicionales

**Escenarios (Criterios de aceptaciÃ³n)**
- Escenario 1: Inicio de sesiÃ³n con Google exitoso
  - Dado que el usuario selecciona "Iniciar sesiÃ³n con Google"
  - Cuando completa la autenticaciÃ³n con Google correctamente
  - Entonces la aplicaciÃ³n debe autenticar al usuario
  - Y crear una cuenta vinculada si es la primera vez
  - Y almacenar el token de autenticaciÃ³n de forma segura
  - Y mostrar la pantalla principal
- Escenario 2: Inicio de sesiÃ³n con Facebook exitoso
  - Dado que el usuario selecciona "Iniciar sesiÃ³n con Facebook"
  - Cuando completa la autenticaciÃ³n con Facebook correctamente
  - Entonces la aplicaciÃ³n debe autenticar al usuario
  - Y crear una cuenta vinculada si es la primera vez
  - Y almacenar el token de autenticaciÃ³n de forma segura
  - Y mostrar la pantalla principal
- Escenario 3: Inicio de sesiÃ³n con Apple exitoso
  - Dado que el usuario selecciona "Iniciar sesiÃ³n con Apple"
  - Cuando completa la autenticaciÃ³n con Apple correctamente
  - Entonces la aplicaciÃ³n debe autenticar al usuario
  - Y crear una cuenta vinculada si es la primera vez
  - Y almacenar el token de autenticaciÃ³n de forma segura
  - Y mostrar la pantalla principal
- Escenario 4: Error de autenticaciÃ³n con proveedor externo
  - Dado que el usuario intenta iniciar sesiÃ³n con un proveedor externo
  - Cuando ocurre un error durante el proceso
  - Entonces la aplicaciÃ³n debe mostrar un mensaje de error especÃ­fico
  - Y permitir intentar con otro mÃ©todo de autenticaciÃ³n
  - Y registrar el error para diagnÃ³stico
- Escenario 5: VinculaciÃ³n de cuenta existente con proveedor
  - Dado que el usuario ya tiene una cuenta tradicional
  - Cuando vincula su cuenta con un proveedor externo
  - Entonces la aplicaciÃ³n debe asociar ambas identidades
  - Y permitir iniciar sesiÃ³n con cualquiera de los mÃ©todos
  - Y mostrar un mensaje de confirmaciÃ³n

**Caso de Uso TÃ©cnico: AutenticaciÃ³n con Proveedor Externo**
- Datos: Proveedor seleccionado (Google, Facebook, Apple), Tokens o credenciales del proveedor
- Curso Principal (happy path):
  - Ejecutar comando "Autenticar con Proveedor" con el proveedor seleccionado.
  - Sistema inicia flujo de autenticaciÃ³n del proveedor.
  - Sistema recibe tokens de autorizaciÃ³n.
  - Sistema valida tokens con el servidor.
  - Sistema almacena token de autenticaciÃ³n propio en el Keychain.
  - Sistema registra la sesiÃ³n en el SessionManager.
  - Sistema notifica Ã©xito de autenticaciÃ³n.
- Curso de error - autenticaciÃ³n cancelada (sad path):
  - Sistema notifica que el proceso fue cancelado.
  - Sistema limpia cualquier token parcial.
- Curso de error - autenticaciÃ³n fallida (sad path):
  - Sistema registra el error especÃ­fico.
  - Sistema notifica error especÃ­fico de autenticaciÃ³n.
  - Sistema sugiere mÃ©todo alternativo.
- Curso de error - sin conectividad (sad path):
  - Sistema notifica error de conectividad.
  - Sistema ofrece reintentar cuando la conexiÃ³n se restablezca.

---

## 10. MÃ©tricas de Seguridad
_(Ver detalles en el documento fuente)_

---

# Notas
- Los escenarios marcados como âœ… estÃ¡n cubiertos por cÃ³digo y tests.
- Los escenarios ğŸ”„ requieren implementaciÃ³n o integraciÃ³n real.
- Los escenarios ğŸ”œ son los siguientes a abordar.

# CÃ³mo usar este documento
- Utiliza este documento como guÃ­a para priorizar el desarrollo y los tests.
- Marca los escenarios como completados a medida que avances.
- AmplÃ­a los escenarios con ejemplos Gherkin si lo deseas (puedo ayudarte a generarlos).


8.- Para la implementaciÃ³n, como usamos TDD (Red-Green-Refactor). crearas la estructura de carpetas dentro del proyecto que tenemos, y arrancaremos con un fichero XCTestCase, en el cual se irÃ¡n generando, tanto las pruebas como el cÃ³digo de producciÃ³n que dichas pruebas nos generarÃ¡, asÃ­ podemos hacer un seguimiento correcto tanto de las pruebas como del cÃ³digo de producciÃ³n que estÃ¡s generan. Una vez terminado el punto del curso, probadas las pruebas, pasaremos ese cÃ³digo de producciÃ³n a su fichero correspondiente fuera de los test.
9.- Lleva siempre un control de versionado con git.
10.- Aunque estÃ¡ especificado en las "rules" actualiza siempre los ficheros de configuraciÃ³n del proyecto(xcodeproj/xcconfig/xcworkspace, o el que corresponda, para que al ejecutarlos en Xcode aparezcan reflejados y dentro de sus correspondientes targets
